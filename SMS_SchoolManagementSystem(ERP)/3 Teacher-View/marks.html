<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marks & Grades - Teacher Portal</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          fontFamily: {
            sans: ['Plus Jakarta Sans', 'Inter', 'sans-serif']
          },
          colors: {
            brand: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            }
          },
          animation: {
            'fade-in-up': 'fadeInUp 0.6s ease-out'
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Plus Jakarta Sans Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    /* Scrollbar Styling - Hide by default */
    html, body { scrollbar-width: none; }
    html::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Focus States */
    *:focus-visible { outline: 2px solid #3b82f6; outline-offset: 2px; }
    input:focus, select:focus, textarea:focus { 
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), inset 0 0 0 1px #3b82f6;
    }
    
    /* Button States */
    button, [role="button"] {
      transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    button:hover, [role="button"]:hover {
      transform: translateY(-1px);
    }
    button:active, [role="button"]:active {
      transform: translateY(0);
    }
    
    /* Card Hover Effects */
    .card-hover {
      transition: all 200ms ease;
    }
    .card-hover:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }
    
    /* Table Styling */
    table tbody tr { transition: background-color 150ms ease; }
    table tbody tr:hover { background-color: rgba(59, 130, 246, 0.05); }
    .dark table tbody tr:hover { background-color: rgba(59, 130, 246, 0.1); }
    
    /* Add left padding to main content area */
    @media (min-width: 1024px) {
      #mainContent {
        padding-left: 1rem !important;
      }
    }
  </style>

  <script>
    // Ensure light theme is default on page load
    (function() {
      const html = document.documentElement;
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        html.classList.add('dark');
      } else {
        html.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      }
    })();
  </script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 transition-colors duration-300">

  <div id="appShell"></div>

  <main id="marksMain" class="hidden w-full max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-in-up">
<br>
    <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
      <div>
        <div class="flex items-center gap-2 mb-2">
          <span class="inline-block w-2 h-2 rounded-full bg-brand-500 animate-pulse"></span>
          <p class="text-[11px] tracking-[0.2em] font-bold text-slate-500 dark:text-slate-400 uppercase">Grade Management</p>
        </div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">
          Marks & Grades
        </h1>
        <p class="text-sm sm:text-base text-slate-600 dark:text-slate-400 mt-2">
          Record and manage student marks for assessments and exams.
        </p>
      </div>
    </header>

    <!-- Marks Entry Form -->
    <section class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl p-6 shadow-sm mb-8">
      <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-6">
        <i class="fas fa-file-alt mr-2 text-brand-600"></i>Enter Student Marks
      </h2>
      
      <form id="marksForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wide">Class</label>
            <select id="classSelect" required class="w-full px-4 py-3 border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500 font-medium">
              <option value="">Select class...</option>
              <option value="8B">Class 8B</option>
              <option value="5A">Class 5A</option>
              <option value="6C">Class 6C</option>
              <option value="7D">Class 7D</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wide">Subject</label>
            <select id="subjectSelect" required class="w-full px-4 py-3 border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500 font-medium">
              <option value="">Select subject...</option>
              <option value="Mathematics">Mathematics</option>
              <option value="Science">Science</option>
              <option value="Physics">Physics</option>
              <option value="English">English</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wide">Assessment</label>
            <select id="assessmentSelect" required class="w-full px-4 py-3 border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500 font-medium">
              <option value="">Select assessment...</option>
              <option value="Unit Test">Unit Test</option>
              <option value="Midterm">Midterm Exam</option>
              <option value="Final">Final Exam</option>
              <option value="Project">Project</option>
              <option value="Assignment">Assignment</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wide">Total Marks</label>
            <input type="number" id="totalMarksInput" required min="0" max="1000" placeholder="e.g., 100" 
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500 font-medium">
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wide">Date of Exam/Test</label>
            <input type="date" id="examDateInput" required class="w-full px-4 py-3 border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded-xl focus:ring-2 focus:ring-brand-500 font-medium">
          </div>
        </div>

        <div id="studentMarksContainer" class="space-y-3 max-h-96 overflow-y-auto scrollbar-hide">
          <!-- Student mark inputs will be dynamically generated -->
        </div>

        <div class="flex gap-3 pt-4 border-t border-slate-200 dark:border-slate-800">
          <button type="submit" class="flex items-center justify-center gap-2 bg-brand-600 hover:bg-brand-700 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg shadow-brand-500/20 transition-all active:scale-95">
            <i class="fas fa-save"></i>
            <span>Submit Marks</span>
          </button>
          <button type="button" onclick="resetMarksForm()" class="flex items-center justify-center gap-2 bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 px-8 py-3.5 rounded-xl font-bold transition-all">
            <i class="fas fa-redo"></i>
            <span>Reset</span>
          </button>
        </div>
      </form>
    </section>

    <!-- Marks Summary -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-gradient-to-br from-brand-50 to-brand-100 dark:from-brand-900/20 dark:to-brand-800/20 rounded-2xl p-6 border border-brand-200 dark:border-brand-800">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-bold text-brand-700 dark:text-brand-400 uppercase tracking-wide">Total Submissions</p>
            <p class="text-3xl font-black text-brand-900 dark:text-brand-100 mt-2" id="totalSubmissions">0</p>
          </div>
          <i class="fas fa-file-check text-4xl text-brand-300 dark:text-brand-700"></i>
        </div>
      </div>

      <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 dark:from-emerald-900/20 dark:to-emerald-800/20 rounded-2xl p-6 border border-emerald-200 dark:border-emerald-800">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-bold text-emerald-700 dark:text-emerald-400 uppercase tracking-wide">Avg Score</p>
            <p class="text-3xl font-black text-emerald-900 dark:text-emerald-100 mt-2" id="avgScore">0%</p>
          </div>
          <i class="fas fa-chart-line text-4xl text-emerald-300 dark:text-emerald-700"></i>
        </div>
      </div>

      <div class="bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/20 dark:to-amber-800/20 rounded-2xl p-6 border border-amber-200 dark:border-amber-800">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-bold text-amber-700 dark:text-amber-400 uppercase tracking-wide">Pending</p>
            <p class="text-3xl font-black text-amber-900 dark:text-amber-100 mt-2" id="pendingCount">0</p>
          </div>
          <i class="fas fa-hourglass-end text-4xl text-amber-300 dark:text-amber-700"></i>
        </div>
      </div>

      <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/20 dark:to-red-800/20 rounded-2xl p-6 border border-red-200 dark:border-red-800">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-bold text-red-700 dark:text-red-400 uppercase tracking-wide">Below Average</p>
            <p class="text-3xl font-black text-red-900 dark:text-red-100 mt-2" id="belowAvgCount">0</p>
          </div>
          <i class="fas fa-triangle-exclamation text-4xl text-red-300 dark:text-red-700"></i>
        </div>
      </div>
    </section>

    <!-- Marks History -->
    <section class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl p-6 shadow-sm">
      <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-6">
        <i class="fas fa-history mr-2 text-amber-600"></i>Mark Submissions
      </h2>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-slate-200 dark:border-slate-800">
              <th class="text-left py-4 px-4 font-bold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide">Class</th>
              <th class="text-left py-4 px-4 font-bold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide">Subject</th>
              <th class="text-left py-4 px-4 font-bold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide">Assessment</th>
              <th class="text-center py-4 px-4 font-bold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide">Total Marks</th>
              <th class="text-center py-4 px-4 font-bold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide">Avg Score</th>
              <th class="text-center py-4 px-4 font-bold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide">Entries</th>
              <th class="text-center py-4 px-4 font-bold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide">Actions</th>
            </tr>
          </thead>
          <tbody id="marksHistoryTable" class="divide-y divide-slate-200 dark:divide-slate-800">
            <!-- Marks history rows will be generated here -->
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script src="../js/data-service.js"></script>
  <script src="../js/error-handler.js"></script>
  <script src="sidebar.js"></script>
  <script src="../js/theme-manager.js"></script>


  <script>
    // Sample students data
    const classStudents = {
      '8B': [
        {name: 'Aarav Singh', rollNo: '01'},
        {name: 'Bhavna Sharma', rollNo: '02'},
        {name: 'Chirag Patel', rollNo: '03'},
        {name: 'Deepika Roy', rollNo: '04'},
        {name: 'Eshan Kumar', rollNo: '05'}
      ],
      '5A': [
        {name: 'Fiona Ahmed', rollNo: '01'},
        {name: 'Gaurav Nair', rollNo: '02'},
        {name: 'Hina Kapoor', rollNo: '03'}
      ],
      '6C': [
        {name: 'Ishita Das', rollNo: '01'},
        {name: 'Jatin Singh', rollNo: '02'},
        {name: 'Karan Desai', rollNo: '03'}
      ],
      '7D': [
        {name: 'Lalita Verma', rollNo: '01'},
        {name: 'Madhav Gupta', rollNo: '02'}
      ]
    };

    let markSubmissions = [];

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('classSelect').addEventListener('change', updateStudentMarks);
      document.getElementById('marksForm').addEventListener('submit', submitMarks);
      loadMarksHistory();
      updateMarksSummary();
    });

    function updateStudentMarks() {
      const selectedClass = document.getElementById('classSelect').value;
      const container = document.getElementById('studentMarksContainer');
      
      if (!selectedClass) {
        container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-sm italic">Select a class first</p>';
        return;
      }

      const students = classStudents[selectedClass] || [];
      container.innerHTML = '';

      if (students.length === 0) {
        container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-sm italic">No students found in this class</p>';
        return;
      }

      students.forEach(student => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700';
        div.innerHTML = `
          <div class="flex-1">
            <p class="text-sm font-bold text-slate-900 dark:text-white">${student.name}</p>
            <p class="text-xs text-slate-500 dark:text-slate-400">Roll: ${student.rollNo}</p>
          </div>
          <input type="number" class="student-marks-input w-20 px-3 py-2 border border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-center font-bold text-sm focus:ring-2 focus:ring-brand-500" 
            data-rollno="${student.rollNo}" min="0" max="100" placeholder="Marks">
        `;
        container.appendChild(div);
      });
    }

    function submitMarks(e) {
      e.preventDefault();

      const selectedClass = document.getElementById('classSelect').value;
      const subject = document.getElementById('subjectSelect').value;
      const assessment = document.getElementById('assessmentSelect').value;
      const totalMarks = parseInt(document.getElementById('totalMarksInput').value);
      const examDate = document.getElementById('examDateInput').value;

      if (!selectedClass || !subject || !assessment || !totalMarks || !examDate) {
        if (typeof NotificationManager !== 'undefined') {
          NotificationManager.warning('Please fill all required fields');
        }
        return;
      }

      const markInputs = document.querySelectorAll('.student-marks-input');
      const studentMarks = [];
      let validCount = 0;

      markInputs.forEach(input => {
        if (input.value) {
          studentMarks.push({
            rollNo: input.dataset.rollno,
            marks: parseInt(input.value)
          });
          validCount++;
        }
      });

      if (validCount === 0) {
        if (typeof NotificationManager !== 'undefined') {
          NotificationManager.warning('Please enter marks for at least one student');
        }
        return;
      }

      const submission = {
        id: markSubmissions.length + 1,
        class: selectedClass,
        subject: subject,
        assessment: assessment,
        totalMarks: totalMarks,
        examDate: examDate,
        entries: validCount,
        avgScore: (studentMarks.reduce((sum, s) => sum + s.marks, 0) / validCount / totalMarks * 100).toFixed(1),
        studentMarks: studentMarks,
        submittedDate: new Date().toISOString().split('T')[0]
      };

      markSubmissions.push(submission);
      loadMarksHistory();
      updateMarksSummary();
      document.getElementById('marksForm').reset();
      document.getElementById('studentMarksContainer').innerHTML = '';

      if (typeof NotificationManager !== 'undefined') {
        NotificationManager.success(`Marks submitted for ${validCount} students`);
      }
    }

    function loadMarksHistory() {
      const tbody = document.getElementById('marksHistoryTable');
      tbody.innerHTML = '';

      markSubmissions.forEach(submission => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors';
        
        const scoreColor = submission.avgScore >= 70 ? 'emerald' : submission.avgScore >= 50 ? 'amber' : 'red';
        
        tr.innerHTML = `
          <td class="py-4 px-4 text-sm font-bold text-slate-900 dark:text-white">Class ${submission.class}</td>
          <td class="py-4 px-4 text-sm font-medium text-slate-700 dark:text-slate-300">${submission.subject}</td>
          <td class="py-4 px-4 text-sm font-medium text-slate-700 dark:text-slate-300">${submission.assessment}</td>
          <td class="py-4 px-4 text-sm font-bold text-slate-900 dark:text-white text-center">${submission.totalMarks}</td>
          <td class="py-4 px-4 text-sm font-bold text-center">
            <span class="px-3 py-1 rounded-full bg-${scoreColor}-100 dark:bg-${scoreColor}-900/20 text-${scoreColor}-700 dark:text-${scoreColor}-400 text-xs font-bold">
              ${submission.avgScore}%
            </span>
          </td>
          <td class="py-4 px-4 text-sm font-bold text-slate-900 dark:text-white text-center">${submission.entries}</td>
          <td class="py-4 px-4 text-sm text-center space-x-2">
            <button onclick="editSubmission(${submission.id})" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-400 hover:text-brand-600 dark:hover:text-brand-400 transition text-xs font-bold">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteSubmission(${submission.id})" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-red-50 dark:bg-red-900/10 text-red-700 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/20 transition text-xs font-bold">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (markSubmissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-slate-500 dark:text-slate-400">No marks submitted yet</td></tr>';
      }
    }

    function updateMarksSummary() {
      const totalSubmissions = markSubmissions.length;
      const totalEntries = markSubmissions.reduce((sum, s) => sum + s.entries, 0);
      const avgScore = markSubmissions.length > 0 
        ? (markSubmissions.reduce((sum, s) => sum + parseFloat(s.avgScore), 0) / markSubmissions.length).toFixed(1)
        : 0;

      document.getElementById('totalSubmissions').textContent = totalSubmissions;
      document.getElementById('avgScore').textContent = avgScore + '%';
      document.getElementById('pendingCount').textContent = Math.max(0, 5 - totalSubmissions);
      document.getElementById('belowAvgCount').textContent = markSubmissions.filter(s => s.avgScore < 50).length;
    }

    function resetMarksForm() {
      document.getElementById('marksForm').reset();
      document.getElementById('studentMarksContainer').innerHTML = '';
    }

    function editSubmission(id) {
      if (typeof NotificationManager !== 'undefined') {
        NotificationManager.info('Edit functionality coming soon');
      }
    }

    function deleteSubmission(id) {
      if (confirm('Delete this mark submission?')) {
        markSubmissions = markSubmissions.filter(s => s.id !== id);
        loadMarksHistory();
        updateMarksSummary();
        if (typeof NotificationManager !== 'undefined') {
          NotificationManager.success('Mark submission deleted');
        }
      }
    }

    // Initialize page content with sidebar
    function initPage() {
      const mainElement = document.getElementById('marksMain');
      const mainContent = document.getElementById('mainContent');
      
      if (mainElement && mainContent) {
        mainContent.innerHTML = mainElement.innerHTML;
        mainElement.remove();
      } else {
        setTimeout(initPage, 100);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>


  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm pointer-events-none"></div>

  <script src="../js/auth-guard.js"></script>
  <script src="../js/global-search.js"></script>
  <script src="../js/notification-service.js"></script>
  <script src="../js/export-service.js"></script>

</body>
</html>

